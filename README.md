# Magic Circle Backend

## Install

```sh
pip3 install poetry
poetry install

npm i # for api-client generation
```

## Start

Everything is controlled through the top level `Makefile`.

```sh
make help              # show help

make dev-db            # starts a dev mariadb
make dev-redis         # used by celery and by the distributed opensea semaphore
make run app=backend   # start backend & create tables
# swagger docs are available on localhost:8000/docs (default x-api-key: admin)
```

## Client Generation

The frontend communicates with the backend through a generated openapi client.
The client is generated by: `https://openapi-generator.tech/docs/`

To publish packages to github packages you will first have to login into the registry.
This will require your github username and a github token.
You can obtain a token on github "Profile => Settings => Developer Settings => Access Token => Classic => Select: write:packages"

Then login into the registry:

```sh
npm login --registry https://npm.pkg.github.com
Username: your_username
Password: your_github_token
```

After successful login, you should be able to publish the package to github packages.
You should also be able to pull the package with `npm i --registry https://npm.pkg.github.com @dimfred/magic-circle-backend`.

```sh
make api-client version=X.Y.Z-rcX # build and publish the api client to github packages
make api-client-build # just build (useful for local setup)
make api-client-publish  # publish the api client to github packages
```

## Database Migrations

Alembic is used for database migrations.

Create new migrations:

```sh
# start a local database first
make dev-db

# upgrade to the latest revision
make alembic-upgrade-head

# create a new revision
make alembic-revision msg='YOUR MESSAGE'

# modify the generated file in alembic/version/* to whatever is needed

# upgrade to the latest revision
make alembic-upgrade-head

# see further alembic commands
make help
```
